<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Panel 3.0 ‚Äî –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#060607;
    --card:#0f1113;
    --card2:#151617;
    --muted:#9aa0a6;
    --accent:#ffd700;
    --accent-2:#f5c518;
    --danger:#ff5c5c;
    --success:#4caf50;
    --glass: rgba(255,255,255,0.03);
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{font-family:'Poppins',sans-serif;background:linear-gradient(180deg,#030304,#0b0b0c);color:#eaeaea;margin:0;padding:18px;}
  a{color:inherit}
  .wrap{max-width:1300px;margin:0 auto;display:flex;flex-direction:column;gap:16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0;color:var(--accent);font-size:20px}
  .sub{color:var(--muted);font-size:13px}

  .main{display:grid;grid-template-columns:260px 1fr;gap:16px}
  /* left menu */
  .menu{background:linear-gradient(180deg,var(--card),var(--card2));border-radius:var(--radius);padding:12px;border:1px solid rgba(255,255,255,0.03)}
  .menu .logo{display:flex;align-items:center;gap:10px}
  .menu .logo .dot{width:36px;height:36px;border-radius:10px;background:linear-gradient(45deg,var(--accent),#ffb800);box-shadow:0 6px 20px rgba(255,183,0,0.12)}
  .menu .menu-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;cursor:pointer;color:var(--muted); transition: background 0.1s}
  .menu .menu-item.active{background:linear-gradient(90deg,rgba(255,215,0,0.06),transparent);color:var(--accent);font-weight:700}
  .menu .menu-item:hover{background:rgba(255,255,255,0.02)}
  .menu .section-title{color:var(--muted);font-size:12px;margin-top:8px;margin-bottom:6px}

  /* content cards */
  .card{background:linear-gradient(180deg,var(--card),rgba(20,20,20,0.6));border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.02)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  input,select,textarea,button{font-family:inherit; transition: border-color 0.2s}
  input,select,textarea{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:#eaeaea; outline: none;}
  input:focus, textarea:focus, select:focus{border-color: var(--accent)}
  textarea{min-height:80px;resize:vertical}
  button{background:var(--accent);color:#111;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700; transition: opacity 0.2s}
  button:hover{opacity: 0.9}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  button.ghost:hover{background:rgba(255,255,255,0.08);opacity:1}
  button.danger{background:var(--danger);color:#111}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;gap:8px;align-items:center}
  .col{display:flex;flex-direction:column;gap:8px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);text-align:left}
  .badge{background:rgba(255,255,255,0.03);padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px; display: inline-block;}
  .pill{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:999px;font-weight:600}
  .stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
  .stat{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:10px;border-radius:10px;text-align:center}
  .log{height:220px;overflow:auto;padding:8px;background:rgba(0,0,0,0.25);border-radius:8px;font-size:13px; white-space: pre-wrap;}
  .overflow{max-height:380px;overflow:auto;padding:6px;border-radius:8px;background:rgba(0,0,0,0.2)}
  .muted-2{color:rgba(255,255,255,0.45);font-size:12px}
  /* modal */
  .modal-back{position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal{width:720px;max-width:95%;background:linear-gradient(180deg,var(--card),var(--card2));padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .modal h3{margin:0 0 10px;color:var(--accent)}
  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
  .flex-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  /* responsive */
  @media (max-width:1000px){
    .main{grid-template-columns:1fr;gap:12px}
    .menu{order:2}
  }
</style>
</head>
<body>

<div class="wrap">

  <header>
    <div>
      <h1>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ‚Äî Admin Panel 3.0</h1>
      <div class="sub">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞–º–∏, –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏, –∑–∞–≥–∞–¥–∫–∞–º–∏, –∑–∞–¥–∞—á–∞–º–∏ –∏ –≤—ã–ø–ª–∞—Ç–∞–º–∏ ‚Äî –≤—Å—ë —á–µ—Ä–µ–∑ localStorage</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="muted">–ê–¥–º–∏–Ω:</div>
      <input id="adminName" placeholder="–ò–º—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞" style="width:180px">
      <button id="exportAll" class="ghost">–≠–∫—Å–ø–æ—Ä—Ç</button>
      <button id="importAll" class="ghost">–ò–º–ø–æ—Ä—Ç</button>
    </div>
  </header>

  <div class="main">

    <div class="menu card">
      <div class="logo" style="margin-bottom:12px">
        <div class="dot"></div>
        <div>
          <div style="font-weight:700;color:var(--accent)">Game Admin</div>
          <div class="muted-2" id="menu-sub">Local mode</div>
        </div>
      </div>

      <div class="section-title">–†–∞–∑–¥–µ–ª—ã</div>
      <div class="menu-item active" data-tab="players"><span>üë•</span> –ò–≥—Ä–æ–∫–∏</div>
      <div class="menu-item" data-tab="promos"><span>üéÅ</span> –ü—Ä–æ–º–æ–∫–æ–¥—ã</div>
      <div class="menu-item" data-tab="riddles"><span>üß©</span> –ó–∞–≥–∞–¥–∫–∏</div>
      <div class="menu-item" data-tab="tasks"><span>üìã</span> –ó–∞–¥–∞—á–∏</div>
      <div class="menu-item" data-tab="withdraws"><span>üí∏</span> –í—ã–≤–æ–¥—ã</div>
      <div class="menu-item" data-tab="settings"><span>‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <div class="menu-item" data-tab="stats"><span>üìä</span> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>

      <div class="section-title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
      <div style="display:flex;gap:8px;flex-direction:column">
        <button id="addDemo" class="small">–î–æ–±–∞–≤–∏—Ç—å –¥–µ–º–æ –∏–≥—Ä–æ–∫–∞</button>
        <button id="pingAll" class="small ghost">–ü–æ–º–µ—Ç–∏—Ç—å –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã–º–∏</button>
        <button id="wipeAll" class="small danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      </div>

    </div>

    <div style="display:flex;flex-direction:column;gap:12px;">

      <div class="card content-tab" id="tab-players">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 style="margin:0;color:var(--accent)">–ò–≥—Ä–æ–∫–∏</h3>
            <div class="muted">–°–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
          </div>
          <div class="row">
            <div class="pill">–û–Ω–ª–∞–π–Ω –ø–æ—Ä–æ–≥: <span id="th-show" style="font-weight:700;margin-left:6px">5</span> –º–∏–Ω</div>
            <input id="searchPlayer" placeholder="–ü–æ–∏—Å–∫: –Ω–∏–∫ / id" style="width:220px">
            <select id="filterOnline" style="width:140px">
              <option value="all">–í—Å–µ</option>
              <option value="online">–û–Ω–ª–∞–π–Ω</option>
              <option value="offline">–û—Ñ—Ñ–ª–∞–π–Ω</option>
              <option value="banned">–ó–∞–±–∞–Ω–µ–Ω–Ω—ã–µ</option>
            </select>
            <select id="sortPlayers" style="width:160px">
              <option value="recent">–ü–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</option>
              <option value="coin_desc">Coin ‚Üì</option>
              <option value="coin_asc">Coin ‚Üë</option>
            </select>
            <button id="openAddPlayer" class="ghost">+ –ò–≥—Ä–æ–∫</button>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <div class="muted-2">–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –±–∞–ª–∞–Ω—Å—É</div>
            <div style="display:flex;gap:8px;margin-top:6px">
              <input id="minCoin" placeholder="min Coin" style="width:120px" type="number">
              <input id="maxCoin" placeholder="max Coin" style="width:120px" type="number">
              <button id="applyBalanceFilter" class="small ghost">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
              <button id="clearFilters" class="small">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <select id="bulkAction" style="width:160px">
              <option value="">–ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</option>
              <option value="give_coin">–í—ã–¥–∞—Ç—å Coin</option>
              <option value="give_ticket">–í—ã–¥–∞—Ç—å Ticket</option>
              <option value="give_usdt">–í—ã–¥–∞—Ç—å USDT</option>
              <option value="give_ton">–í—ã–¥–∞—Ç—å TON</option>
              <option value="ban">–ó–∞–±–∞–Ω–∏—Ç—å</option>
              <option value="unban">–†–∞–∑–±–∞–Ω–∏—Ç—å</option>
            </select>
            <input id="bulkValue" placeholder="–°—É–º–º–∞" style="width:100px" type="number">
            <button id="applyBulk" class="small">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          </div>
        </div>

        <div style="margin-top:12px" class="overflow">
          <table id="playersTable">
            <thead><tr><th>–ù–∏–∫ / ID</th><th>–ë–∞–ª–∞–Ω—Å C / TON / USDT / T</th><th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th><th>–û–Ω–ª–∞–π–Ω</th><th>–ë–∞–Ω</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <div class="muted">–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤: <span id="playersCount">0</span></div>
          <div style="display:flex;gap:8px">
            <button id="exportPlayers" class="ghost">–≠–∫—Å–ø–æ—Ä—Ç –∏–≥—Ä–æ–∫–æ–≤</button>
            <button id="importPlayers" class="ghost">–ò–º–ø–æ—Ä—Ç</button>
          </div>
        </div>
      </div>

      <div class="card content-tab" id="tab-promos" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 style="margin:0;color:var(--accent)">–ü—Ä–æ–º–æ–∫–æ–¥—ã</h3>
            <div class="muted">–°–æ–∑–¥–∞–≤–∞–π –∫–æ–¥—ã —Å –ª–∏–º–∏—Ç–æ–º –∏ –Ω–∞–≥—Ä–∞–¥–æ–π –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∞–ª—é—Ç–∞—Ö</div>
          </div>
          <div class="row">
            <button id="openAddPromo" class="small">+ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
            <button id="exportPromos" class="ghost">–≠–∫—Å–ø–æ—Ä—Ç</button>
            <button id="clearPromos" class="danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
          </div>
        </div>

        <div style="margin-top:12px" class="overflow" id="promosList"></div>
      </div>

      <div class="card content-tab" id="tab-riddles" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 style="margin:0;color:var(--accent)">–ó–∞–≥–∞–¥–∫–∏ ‚Äî —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h3>
            <div class="muted">–î–æ–±–∞–≤–ª—è–π –∑–∞–≥–∞–¥–∫–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã (YYYY-MM-DD). –ò–≥—Ä–∞ –±–µ—Ä—ë—Ç –∑–∞–≥–∞–¥–∫—É –ø–æ —Å–µ–≥–æ–¥–Ω—è.</div>
          </div>
          <div class="row">
            <button id="openAddRiddle" class="small">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–∞–¥–∫—É</button>
            <button id="exportRiddles" class="ghost">–≠–∫—Å–ø–æ—Ä—Ç</button>
            <button id="clearRiddles" class="danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
          </div>
        </div>

        <div style="margin-top:12px" class="overflow" id="riddlesList"></div>
      </div>

      <div class="card content-tab" id="tab-tasks" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 style="margin:0;color:var(--accent)">–ó–∞–¥–∞—á–∏</h3>
            <div class="muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ –∏ –Ω–∞–≥—Ä–∞–¥–∞–º–∏</div>
          </div>
          <div>
            <button id="openAddTask" class="small">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
            <button id="exportTasks" class="ghost">–≠–∫—Å–ø–æ—Ä—Ç</button>
          </div>
        </div>

        <div style="margin-top:12px" class="overflow" id="tasksList"></div>
      </div>

      <div class="card content-tab" id="tab-withdraws" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 style="margin:0;color:var(--accent)">–ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥</h3>
            <div class="muted">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</div>
          </div>
          <div>
            <button id="exportWithdraws" class="ghost">–≠–∫—Å–ø–æ—Ä—Ç</button>
          </div>
        </div>

        <div style="margin-top:12px" class="overflow" id="withdrawsList"></div>

        <div style="margin-top:10px">
          <h4 class="muted">–ó–∞—è–≤–∫–∏ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –Ω–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è (Task Submissions)</h4>
          <div id="submissionsList" class="overflow" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="card content-tab" id="tab-settings" style="display:none">
        <h3 style="color:var(--accent)">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <div class="muted">–û–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</div>

        <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="card" style="padding:10px">
            <div class="muted-2">–û–Ω–ª–∞–π–Ω: –ø–æ—Ä–æ–≥ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (–≤ –º–∏–Ω—É—Ç–∞—Ö)</div>
            <div class="row" style="margin-top:8px">
              <input id="onlineThreshold" type="number" min="1" value="5" style="width:100px">
              <button id="saveThreshold" class="small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </div>

          <div class="card" style="padding:10px">
            <div class="muted-2">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</div>
            <div style="margin-top:8px" class="muted">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage. –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å –∫–ª—é—á–∏ –∏ —Å–ª—É—à–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ "storage".</div>
            <div style="margin-top:10px" class="row">
              <button id="notifySync" class="ghost">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∏–≥–Ω–∞–ª sync</button>
              <button id="clearLocalStorage" class="danger">–û—á–∏—Å—Ç–∏—Ç—å localStorage</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <h4 class="muted">–õ–æ–≥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h4>
          <div id="adminLog" class="log"></div>
        </div>
      </div>

      <div class="card content-tab" id="tab-stats" style="display:none">
        <h3 style="color:var(--accent)">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <div class="muted">–ö—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏–≥—Ä–æ–∫–∞–º –∏ —ç–∫–æ–Ω–æ–º–∏–∫–µ</div>

        <div class="stat-grid">
          <div class="stat"><div class="muted-2">–ò–≥—Ä–æ–∫–æ–≤</div><div id="statPlayers" style="font-weight:700;font-size:18px">0</div></div>
          <div class="stat"><div class="muted-2">–û–Ω–ª–∞–π–Ω</div><div id="statOnline" style="font-weight:700;font-size:18px">0</div></div>
          <div class="stat"><div class="muted-2">–í—Å–µ–≥–æ Coin</div><div id="statCoin" style="font-weight:700;font-size:18px">0</div></div>
          <div class="stat"><div class="muted-2">–í—Å–µ–≥–æ USDT</div><div id="statUSDT" style="font-weight:700;font-size:18px">0</div></div>
          <div class="stat"><div class="muted-2">–í—Å–µ–≥–æ TON</div><div id="statTON" style="font-weight:700;font-size:18px">0</div></div>
          <div class="stat"><div class="muted-2">–í—Å–µ–≥–æ Tickets</div><div id="statTickets" style="font-weight:700;font-size:18px">0</div></div>
          <div class="stat"><div class="muted-2">–û–∂–∏–¥–∞—é—â–∏–µ –≤—ã–≤–æ–¥—ã</div><div id="statWD" style="font-weight:700;font-size:18px">0</div></div>
          <div class="stat"><div class="muted-2">–û–∂–∏–¥–∞—é—â–∏–µ –∑–∞—è–≤–∫–∏</div><div id="statSubs" style="font-weight:700;font-size:18px">0</div></div>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="modal" class="modal-back">
  <div class="modal" id="modalContent"></div>
</div>

<script>
/*
  Admin Panel 3.0 ‚Äî –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (Refactored)
  - –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
  - –ö–ª—é—á–∏: players, promoCodes, riddles, tasks, withdrawRequests, taskSubmissions, transactionHistory, adminLog, admin_online_threshold
  - –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–¥.
  - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã input minCoin/maxCoin.
*/

/* ----------------- Helpers ----------------- */
const uid = () => 'id_' + Math.random().toString(36).slice(2,9);
const nowISO = () => new Date().toISOString();
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function load(k,def){ try{ const v = JSON.parse(localStorage.getItem(k)); return v===null?def:(v||def); }catch(e){ return def; } }
function logAdmin(msg){ const arr = load('adminLog', []); arr.unshift({t: new Date().toLocaleString(), m: msg}); while(arr.length>500) arr.pop(); save('adminLog', arr); renderAdminLog(); }
function toast(msg){ console.log(msg); alert(msg); }
function downloadJSON(obj, filename){ const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); }
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
function isoToLocal(iso){ try{ return new Date(iso).toLocaleString(); }catch(e){ return iso; } }
function getThreshold(){ return Number(localStorage.getItem('admin_online_threshold') || (document.getElementById('onlineThreshold')?.value || 5)); }
function isPlayerOnline(p, thresholdMin){ if(!p.lastActive) return false; return (Date.now() - new Date(p.lastActive).getTime()) <= thresholdMin*60*1000 && !p.banned; }
function totals(players){ return players.reduce((acc,p)=>{ acc.coin += Number(p.coin||0); acc.usdt += Number(p.usdt||0); acc.ton += Number(p.ton||0); acc.ticket += Number(p.ticket||0); return acc; }, {coin:0,usdt:0,ton:0,ticket:0}); }
function pushTransaction(playerId, amount, currency, type, source){ const hist = load('transactionHistory', []); hist.unshift({id:uid(), date: nowISO(), playerId, amount, currency, type, source}); while(hist.length>2000) hist.pop(); save('transactionHistory', hist); localStorage.setItem('lastAdminAction', JSON.stringify({t:'transaction',ts:Date.now()})); }


/* ----------------- Init default data if missing ----------------- */
if(!localStorage.getItem('players')){
  save('players', [
    {id:uid(), nick:'–ò–≥—Ä–æ–∫_A', coin:1200, ton:0.25, usdt:0.5, ticket:10, lastActive: new Date(Date.now()-1000*60*2).toISOString(), banned:false, created: nowISO()},
    {id:uid(), nick:'–ò–≥—Ä–æ–∫_B', coin:350, ton:0, usdt:1.0, ticket:3, lastActive: new Date(Date.now()-1000*60*60).toISOString(), banned:false, created: nowISO()}
  ]);
}
if(!localStorage.getItem('promoCodes')) {
  save('promoCodes', [
    {code:'WELCOME2025', maxUses:100, uses:0, reward:{coin:10,ticket:1,usdt:0,ton:0}, active:true, created: nowISO()},
    {code:'TICKET50', maxUses:50, uses:0, reward:{coin:0,ticket:5,usdt:0,ton:0}, active:true, created: nowISO()}
  ]);
}
if(!localStorage.getItem('riddles')) save('riddles', [{id:uid(), date:new Date().toISOString().slice(0,10), q:'–ß—Ç–æ –∏–º–µ–µ—Ç –∫–ª—é—á–∏, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å?', answer:'–ø–∏–∞–Ω–∏–Ω–æ', created: nowISO()}]);
if(!localStorage.getItem('tasks')) save('tasks', []);
if(!localStorage.getItem('withdrawRequests')) save('withdrawRequests', [{id:uid(), playerId: load('players')[0].id, amount: 10, currency: 'TON', wallet: 'EQ...test', status: 'new', date: nowISO()}]);
if(!localStorage.getItem('taskSubmissions')) save('taskSubmissions', [{id:uid(), playerId: load('players')[1].id, text: '–ü—Ä–µ–¥–ª–∞–≥–∞—é –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É: "–°–¥–µ–ª–∞–π 5 —Ä–µ–ø–æ—Å—Ç–æ–≤"', status: 'new', date: nowISO()}]);
if(!localStorage.getItem('transactionHistory')) save('transactionHistory', []);
if(!localStorage.getItem('adminLog')) save('adminLog', []);
if(!localStorage.getItem('admin_online_threshold')) localStorage.setItem('admin_online_threshold', '5');

/* ----------------- UI refs ----------------- */
const tabs = document.querySelectorAll('.menu .menu-item');
const contentTabs = document.querySelectorAll('.content-tab');
const modalBack = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
const adminNameInput = document.getElementById('adminName');
const playersTableBody = document.querySelector('#playersTable tbody');
const searchPlayer = document.getElementById('searchPlayer');
const filterOnline = document.getElementById('filterOnline');
const sortPlayers = document.getElementById('sortPlayers');
// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ input'—ã minCoin –∏ maxCoin
const searchMinCoin = document.getElementById('minCoin');
const searchMaxCoin = document.getElementById('maxCoin');
// –ö–æ–Ω–µ—Ü –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø
const playersCountEl = document.getElementById('playersCount');
const thShow = document.getElementById('th-show');
const onlineThresholdInput = document.getElementById('onlineThreshold');
const playersStat = document.getElementById('statPlayers');
const onlineStat = document.getElementById('statOnline');
const statCoin = document.getElementById('statCoin');
const statUSDT = document.getElementById('statUSDT');
const statTON = document.getElementById('statTON');
const statTickets = document.getElementById('statTickets');
const statWD = document.getElementById('statWD');
const statSubs = document.getElementById('statSubs');
const promosList = document.getElementById('promosList');
const riddlesList = document.getElementById('riddlesList');
const tasksList = document.getElementById('tasksList');
const withdrawsList = document.getElementById('withdrawsList');
const submissionsList = document.getElementById('submissionsList');
const adminLogDiv = document.getElementById('adminLog');

/* ----------------- Actions (Data Manipulation) ----------------- */
/* Player actions */
function addPlayer(nick){
  const players = load('players', []);
  const p = {id:uid(), nick:nick||'–ù–æ–≤—ã–π –∏–≥—Ä–æ–∫', coin:0, ton:0, usdt:0, ticket:0, lastActive: nowISO(), banned:false, created: nowISO()};
  players.unshift(p);
  save('players', players);
  logAdmin('–î–æ–±–∞–≤–ª–µ–Ω –∏–≥—Ä–æ–∫ '+p.nick);
  return p;
}

function toggleBan(playerId){
  const players = load('players', []);
  const ix = players.findIndex(p=>p.id===playerId);
  if(ix===-1) return;
  players[ix].banned = !players[ix].banned;
  save('players', players);
  logAdmin(`${players[ix].banned? '–ó–∞–±–∞–Ω–µ–Ω':'–†–∞–∑–±–∞–Ω–µ–Ω'} ${players[ix].nick}`);
  renderAll();
}

function editPlayer(playerId, data){
  const players = load('players', []);
  const ix = players.findIndex(p=>p.id===playerId);
  if(ix===-1) return;
  players[ix] = {...players[ix], ...data};
  save('players', players);
  logAdmin('–ò–∑–º–µ–Ω—ë–Ω –∏–≥—Ä–æ–∫ '+players[ix].nick);
  renderAll();
}

function bulkActionApply(action, value){
  const players = load('players', []);
  players.forEach(p=>{
    if(action==='give_coin') p.coin = (p.coin||0) + Number(value||0);
    if(action==='give_ticket') p.ticket = (p.ticket||0) + Number(value||0);
    if(action==='give_usdt') p.usdt = (p.usdt||0) + Number(value||0);
    if(action==='give_ton') p.ton = (p.ton||0) + Number(value||0);
    if(action==='ban') p.banned = true;
    if(action==='unban') p.banned = false;
    if(['give_coin', 'give_ticket', 'give_usdt', 'give_ton'].includes(action)) {
        pushTransaction(p.id, Number(value||0), action.replace('give_', '').toUpperCase(), 'admin_bulk', adminNameInput.value || 'admin');
    }
  });
  save('players', players);
  logAdmin(`–ú–∞—Å—Å–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ${action} value:${value}`);
  renderAll();
}

/* Promos */
function addPromo(code, maxUses, reward){
  const arr = load('promoCodes', []);
  arr.unshift({code:code.toUpperCase(), maxUses: Number(maxUses)||1, uses:0, reward:reward, active:true, created: nowISO()});
  save('promoCodes', arr);
  logAdmin('–î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–æ–º–æ–∫–æ–¥ '+code);
  renderPromos();
}

function deletePromo(code){
  const arr = load('promoCodes', []);
  const i = arr.findIndex(x=>x.code===code);
  if(i>-1){
    arr.splice(i,1);
    save('promoCodes', arr);
    logAdmin('–£–¥–∞–ª—ë–Ω –ø—Ä–æ–º–æ–∫–æ–¥ '+code);
    renderPromos();
  }
}

function togglePromo(code){
  const arr = load('promoCodes', []);
  const i = arr.findIndex(x=>x.code===code);
  if(i>-1){
    arr[i].active = !arr[i].active;
    save('promoCodes', arr);
    logAdmin(`${arr[i].active? '–í–∫–ª—é—á–µ–Ω':'–û—Ç–∫–ª—é—á–µ–Ω'} –ø—Ä–æ–º–æ–∫–æ–¥ ${code}`);
    renderPromos();
  }
}

function redeemPromo(playerId, code){
  const players = load('players', []);
  const p = players.find(x=>x.id===playerId);
  if(!p) return toast('–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
  const promos = load('promoCodes', []);
  const promo = promos.find(x=>x.code===code);
  if(!promo) return toast('–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
  if(!promo.active) return toast('–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω');
  if(promo.uses >= promo.maxUses) return toast('–ü—Ä–æ–º–æ–∫–æ–¥ –∏—Å—á–µ—Ä–ø–∞–Ω');
  
  // Check if player already used this promo
  // This requires a history of promo redemptions, which is not tracked in the current schema.
  // For now, we only check maxUses.

  promo.uses++;
  p.coin = (p.coin||0) + (promo.reward.coin||0);
  p.ticket = (p.ticket||0) + (promo.reward.ticket||0);
  p.usdt = (p.usdt||0) + (promo.reward.usdt||0);
  p.ton = (p.ton||0) + (promo.reward.ton||0);
  
  save('players', players);
  save('promoCodes', promos);
  pushTransaction(playerId, 0, 'PROMO', 'promo_redeem', code);
  logAdmin(`–ü—Ä–æ–º–æ–∫–æ–¥ ${code} –ø—Ä–∏–º–µ–Ω—ë–Ω –∫ ${p.nick}`);
  renderAll();
  return toast(`–ü—Ä–æ–º–æ–∫–æ–¥ ${code} —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω—ë–Ω –∫ ${p.nick}!`);
}

/* Riddles */
function addRiddle(date, q, a){
  const arr = load('riddles', []);
  arr.unshift({id:uid(), date, q, answer:a, created: nowISO()});
  save('riddles', arr);
  logAdmin('–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≥–∞–¥–∫–∞ –Ω–∞ '+date);
  renderRiddles();
}

function deleteRiddle(id){
  const arr = load('riddles', []);
  const i = arr.findIndex(x=>x.id===id);
  if(i>-1){
    arr.splice(i,1);
    save('riddles', arr);
    logAdmin('–£–¥–∞–ª–µ–Ω–∞ –∑–∞–≥–∞–¥–∫–∞');
    renderRiddles();
  }
}

function editRiddle(id, data){
  const arr = load('riddles', []);
  const i = arr.findIndex(x=>x.id===id);
  if(i>-1){
    arr[i] = {...arr[i], ...data};
    save('riddles', arr);
    logAdmin('–ò–∑–º–µ–Ω–µ–Ω–∞ –∑–∞–≥–∞–¥–∫–∞ '+id);
    renderRiddles();
  }
}

/* Tasks */
function addTask(title, reward){
  const arr = load('tasks', []);
  arr.unshift({id:uid(), title, reward, created: nowISO()});
  save('tasks', arr);
  logAdmin('–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–¥–∞—á–∞: '+title);
  renderTasks();
}

function deleteTask(id){
  const arr = load('tasks', []);
  const i = arr.findIndex(x=>x.id===id);
  if(i>-1){
    arr.splice(i,1);
    save('tasks', arr);
    logAdmin('–£–¥–∞–ª–µ–Ω–∞ –∑–∞–¥–∞—á–∞');
    renderTasks();
  }
}

/* Withdraws */
function executeWithdraw(req){
  const players = load('players', []);
  const p = players.find(x=>x.id===req.playerId);
  if(!p) return;
  const cur = req.currency.toLowerCase();
  const amount = Number(req.amount) || 0;
  
  // –í –∞–¥–º–∏–Ω–∫–µ –≤—ã–≤–æ–¥ —É–∂–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ, –∞ –Ω–µ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏.
  // –ó–¥–µ—Å—å –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 'new', —Ç–æ –±–∞–ª–∞–Ω—Å —É–∂–µ —Å–ø–∏—Å–∞–Ω. –ü—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å.
  // –ß—Ç–æ–±—ã –Ω–µ —Å–ø–∏—Å—ã–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ, —É–±–µ—Ä–µ–º –ª–æ–≥–∏–∫—É —Å–ø–∏—Å–∞–Ω–∏—è. –ï—Å–ª–∏ –±—ã –ª–æ–≥–∏–∫–∞ –±—ã–ª–∞ "—Å–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏",
  // —Ç–æ –∫–æ–¥ –Ω–∏–∂–µ –±—ã–ª –±—ã –∞–∫—Ç—É–∞–ª–µ–Ω. –ù–æ –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ –ª–æ–≥–∏–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –Ω–µ –±—ã–ª–∞ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–∞.
  
  // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–ø–∏—Å—ã–≤–∞—Ç—å –±–∞–ª–∞–Ω—Å –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ (–±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ):
  // if(cur==='coin') p.coin = Math.max(0, (p.coin||0) - amount);
  // ... –∏ —Ç.–¥.
  
  save('players', players);
  pushTransaction(p.id, amount, req.currency, 'withdraw_accepted', 'admin');
}

function acceptWithdraw(id){
  const arr = load('withdrawRequests', []);
  const i = arr.findIndex(x=>x.id===id);
  if(i===-1) return;
  const req = arr[i];
  if(req.status!=='new') return toast('–ó–∞—è–≤–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞');
  req.status = 'accepted';
  save('withdrawRequests', arr);
  // executeWithdraw(req); // –í —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–µ —Å–ø–∏—Å–∞–Ω–∏—è –Ω–µ—Ç, —Ç–æ–ª—å–∫–æ —Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞
  logAdmin('–í—ã–≤–æ–¥ –ø—Ä–∏–Ω—è—Ç '+id);
  renderWithdraws();
}

function rejectWithdraw(id){
  const arr = load('withdrawRequests', []);
  const i = arr.findIndex(x=>x.id===id);
  if(i===-1) return;
  const req = arr[i];
  if(req.status!=='new') return toast('–ó–∞—è–≤–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞');
  arr[i].status = 'rejected';
  save('withdrawRequests', arr);
  
  // –ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ ‚Äî –≤–µ—Ä–Ω—É—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫—É
  const players = load('players', []);
  const p = players.find(x=>x.id===req.playerId);
  if(p){
    const cur = req.currency.toLowerCase();
    const amount = Number(req.amount) || 0;
    if(cur==='coin') p.coin = (p.coin||0) + amount;
    if(cur==='usdt') p.usdt = (p.usdt||0) + amount;
    if(cur==='ton') p.ton = (p.ton||0) + amount;
    if(cur==='ticket') p.ticket = (p.ticket||0) + amount;
    save('players', players);
    pushTransaction(p.id, amount, req.currency, 'withdraw_rejected_refund', 'admin');
  }

  logAdmin('–í—ã–≤–æ–¥ –æ—Ç–∫–ª–æ–Ω—ë–Ω '+id);
  renderWithdraws();
}

/* Submissions */
function approveSubmission(id){
  const arr = load('taskSubmissions', []);
  const i = arr.findIndex(x=>x.id===id);
  if(i===-1) return;
  const s = arr[i];
  if(s.status!=='new') return toast('–ó–∞—è–≤–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞');
  s.status='approved';
  save('taskSubmissions', arr);
  addTask(s.text, {coin:1,ticket:0,usdt:0,ton:0}); // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
  logAdmin('–ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–∞–∫ –∑–∞–¥–∞—á–∞');
  renderWithdraws();
}

function rejectSubmission(id){
  const arr = load('taskSubmissions', []);
  const i = arr.findIndex(x=>x.id===id);
  if(i===-1) return;
  if(arr[i].status!=='new') return toast('–ó–∞—è–≤–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞');
  arr[i].status='rejected';
  save('taskSubmissions', arr);
  logAdmin('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
  renderWithdraws();
}

/* ----------------- Modal windows ----------------- */
function openModal(html){ modalContent.innerHTML = html; modalBack.style.display = 'flex'; }
function closeModal(){ modalBack.style.display = 'none'; modalContent.innerHTML = ''; }

/* Edit player modal */
function openEditPlayerModal(playerId){
  const players = load('players', []);
  const p = players.find(x=>x.id===playerId);
  if(!p) return;
  const html = `
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞</h3>
    <div class="field"><label>ID</label><div class="muted-2">${p.id}</div></div>
    <div class="field"><label>–ù–∏–∫</label><input id="m_nick" value="${escapeHtml(p.nick)}"></div>
    <div class="field"><label>Coin</label><input id="m_coin" value="${p.coin}" type="number"></div>
    <div class="field"><label>Ticket</label><input id="m_ticket" value="${p.ticket}" type="number"></div>
    <div class="field"><label>USDT</label><input id="m_usdt" value="${p.usdt}" type="number"></div>
    <div class="field"><label>TON</label><input id="m_ton" value="${p.ton}" type="number"></div>
    <div class="field"><label>–ë–∞–Ω</label>
      <select id="m_banned">
        <option value="false" ${p.banned?'':'selected'}>–ù–µ—Ç</option>
        <option value="true" ${p.banned?'selected':''}>–î–∞</option>
      </select>
    </div>
    <div class="actions">
      <button id="savePlayer" data-id="${p.id}" class="small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="cancelEdit" class="small ghost">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;
  openModal(html);
  document.getElementById('cancelEdit').addEventListener('click', closeModal);
  document.getElementById('savePlayer').addEventListener('click', (e)=>{
    const id = e.target.dataset.id;
    editPlayer(id, {
      nick: document.getElementById('m_nick').value.trim(),
      coin: Number(document.getElementById('m_coin').value) || 0,
      ticket: Number(document.getElementById('m_ticket').value) || 0,
      usdt: Number(document.getElementById('m_usdt').value) || 0,
      ton: Number(document.getElementById('m_ton').value) || 0,
      banned: document.getElementById('m_banned').value === 'true'
    });
    closeModal();
  });
}

/* Bonus modal */
function openBonusModal(playerId){
  const players = load('players', []);
  const p = players.find(x=>x.id===playerId);
  if(!p) return;
  const html = `
    <h3>–í—ã–¥–∞—Ç—å –±–æ–Ω—É—Å</h3>
    <div class="field"><label>–ò–≥—Ä–æ–∫</label><div class="muted-2">${p.nick} (${p.id})</div></div>
    <div class="field"><label>–í–∞–ª—é—Ç–∞</label>
      <select id="b_cur">
        <option value="coin">Coin</option>
        <option value="ticket">Ticket</option>
        <option value="usdt">USDT</option>
        <option value="ton">TON</option>
      </select>
    </div>
    <div class="field"><label>–°—É–º–º–∞</label><input id="b_amount" value="10" type="number"></div>
    <div class="actions">
      <button id="sendBonus" data-id="${p.id}" class="small">–í—ã–¥–∞—Ç—å</button>
      <button id="cancelBonus" class="small ghost">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;
  openModal(html);
  document.getElementById('cancelBonus').addEventListener('click', closeModal);
  document.getElementById('sendBonus').addEventListener('click', (e)=>{
    const id = e.target.dataset.id;
    const cur = document.getElementById('b_cur').value;
    const amt = Number(document.getElementById('b_amount').value) || 0;
    const players = load('players', []);
    const player = players.find(x=>x.id===id);
    if(!player) return;
    
    if(cur==='coin') player.coin = (player.coin||0) + amt;
    if(cur==='ticket') player.ticket = (player.ticket||0) + amt;
    if(cur==='usdt') player.usdt = (player.usdt||0) + amt;
    if(cur==='ton') player.ton = (player.ton||0) + amt;
    
    save('players', players);
    pushTransaction(id, amt, cur.toUpperCase(), 'admin_bonus', adminNameInput.value || 'admin');
    logAdmin(`–ë–æ–Ω—É—Å ${amt} ${cur.toUpperCase()} -> ${player.nick}`);
    closeModal();
    renderAll();
  });
}

/* Add player modal */
function openAddPlayerModal(){
  const html = `<h3>–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</h3> <div class="field"><label>–ù–∏–∫</label><input id="newNick"></div> <div class="field"><label>Coin (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label><input id="newCoin" value="0" type="number"></div> <div class="actions"><button id="createPlayer" class="small">–°–æ–∑–¥–∞—Ç—å</button><button id="cancelCreate" class="small ghost">–û—Ç–º–µ–Ω–∞</button></div>`;
  openModal(html);
  document.getElementById('cancelCreate').addEventListener('click', closeModal);
  document.getElementById('createPlayer').addEventListener('click', ()=>{
    const nick = document.getElementById('newNick').value.trim();
    if(!nick) return toast('–ù–∏–∫ –ø—É—Å—Ç–æ–π');
    const coin = Number(document.getElementById('newCoin').value) || 0;
    const p = addPlayer(nick);
    editPlayer(p.id, {coin});
    closeModal();
  });
}

/* Promo modal */
function openAddPromoModal(){
  const html = `<h3>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h3> <div class="field"><label>–ö–æ–¥</label><input id="promo_code"></div> <div class="field"><label>–ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</label><input id="promo_max" value="1" type="number"></div> <div class="field"><label>–ù–∞–≥—Ä–∞–¥–∞ ‚Äî Coin</label><input id="promo_coin" value="0" type="number"></div> <div class="field"><label>–ù–∞–≥—Ä–∞–¥–∞ ‚Äî Ticket</label><input id="promo_ticket" value="0" type="number"></div> <div class="field"><label>–ù–∞–≥—Ä–∞–¥–∞ ‚Äî USDT</label><input id="promo_usdt" value="0" type="number"></div> <div class="field"><label>–ù–∞–≥—Ä–∞–¥–∞ ‚Äî TON</label><input id="promo_ton" value="0" type="number"></div> <div class="actions"><button id="createPromo" class="small">–°–æ–∑–¥–∞—Ç—å</button><button id="cancelPromo" class="small ghost">–û—Ç–º–µ–Ω–∞</button></div>`;
  openModal(html);
  document.getElementById('cancelPromo').addEventListener('click', closeModal);
  document.getElementById('createPromo').addEventListener('click', ()=>{
    const code = document.getElementById('promo_code').value.trim();
    const max = Number(document.getElementById('promo_max').value) || 1;
    const reward = {
      coin: Number(document.getElementById('promo_coin').value)||0, 
      ticket: Number(document.getElementById('promo_ticket').value)||0, 
      usdt: Number(document.getElementById('promo_usdt').value)||0, 
      ton: Number(document.getElementById('promo_ton').value)||0
    };
    if(!code) return toast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥');
    addPromo(code, max, reward);
    closeModal();
  });
}

/* Simulate promo modal */
function openSimulatePromoModal(code){
  const html = `<h3>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ (—Å–∏–º—É–ª—è—Ü–∏—è)</h3> <div class="field"><label>–ü—Ä–æ–º–æ–∫–æ–¥</label><div class="muted-2">${code}</div></div> <div class="field"><label>–ò–≥—Ä–æ–∫ (ID)</label><input id="sim_player" placeholder="id_..."></div> <div class="actions"><button id="simApply" data-code="${code}" class="small">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button><button id="simCancel" class="small ghost">–û—Ç–º–µ–Ω–∞</button></div>`;
  openModal(html);
  document.getElementById('simCancel').addEventListener('click', closeModal);
  document.getElementById('simApply').addEventListener('click', (e)=>{
    const pid = document.getElementById('sim_player').value.trim();
    const c = e.target.dataset.code;
    if(!pid) return toast('–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä–æ–∫–∞');
    redeemPromo(pid, c);
    closeModal();
  });
}

/* Add riddle modal */
function openAddRiddleModal(){
  const html = `<h3>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–∞–¥–∫—É</h3> <div class="field"><label>–î–∞—Ç–∞ (YYYY-MM-DD)</label><input id="r_date" value="${new Date().toISOString().slice(0,10)}" type="date"></div> <div class="field"><label>–í–æ–ø—Ä–æ—Å</label><input id="r_q"></div> <div class="field"><label>–û—Ç–≤–µ—Ç</label><input id="r_a"></div> <div class="actions"><button id="saveRiddle" class="small">–î–æ–±–∞–≤–∏—Ç—å</button><button id="cancelRiddle" class="small ghost">–û—Ç–º–µ–Ω–∞</button></div>`;
  openModal(html);
  document.getElementById('cancelRiddle').addEventListener('click', closeModal);
  document.getElementById('saveRiddle').addEventListener('click', ()=>{
    const date = document.getElementById('r_date').value.trim();
    const q = document.getElementById('r_q').value.trim();
    const a = document.getElementById('r_a').value.trim();
    if(!date || !q) return toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞—Ç—É –∏ –≤–æ–ø—Ä–æ—Å');
    addRiddle(date, q, a);
    closeModal();
  });
}

/* Edit riddle modal */
function openEditRiddleModal(id){
  const arr = load('riddles', []);
  const r = arr.find(x=>x.id===id);
  if(!r) return;
  const html = `<h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥–∞–¥–∫—É</h3> <div class="field"><label>–î–∞—Ç–∞</label><input id="er_date" value="${r.date}" type="date"></div> <div class="field"><label>–í–æ–ø—Ä–æ—Å</label><input id="er_q" value="${escapeHtml(r.q)}"></div> <div class="field"><label>–û—Ç–≤–µ—Ç</label><input id="er_a" value="${escapeHtml(r.answer||'')}"></div> <div class="actions"><button id="saveER" data-id="${id}" class="small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button id="cancelER" class="small ghost">–û—Ç–º–µ–Ω–∞</button></div>`;
  openModal(html);
  document.getElementById('cancelER').addEventListener('click', closeModal);
  document.getElementById('saveER').addEventListener('click', (e)=>{
    editRiddle(e.target.dataset.id, {
      date: document.getElementById('er_date').value.trim(), 
      q: document.getElementById('er_q').value.trim(), 
      answer: document.getElementById('er_a').value.trim()
    });
    closeModal();
  });
}

/* Add task modal */
function openAddTaskModal(){
  const html = `<h3>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h3> <div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="t_title"></div> <div class="field"><label>Reward ‚Äî coin</label><input id="t_coin" value="1" type="number"></div> <div class="actions"><button id="createTask" class="small">–°–æ–∑–¥–∞—Ç—å</button><button id="cancelTask" class="small ghost">–û—Ç–º–µ–Ω–∞</button></div>`;
  openModal(html);
  document.getElementById('cancelTask').addEventListener('click', closeModal);
  document.getElementById('createTask').addEventListener('click', ()=>{
    const title = document.getElementById('t_title').value.trim();
    if(!title) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
    const coin = Number(document.getElementById('t_coin').value)||0;
    addTask(title, {coin, ticket:0, usdt:0, ton:0});
    closeModal();
  });
}


/* ----------------- Render functions (UI) ----------------- */
function renderPlayers(){
  const players = load('players', []);
  const tbody = playersTableBody;
  tbody.innerHTML = '';
  const q = (searchPlayer.value||'').trim().toLowerCase();
  const filter = filterOnline.value;
  // –¢–µ–ø–µ—Ä—å searchMinCoin –∏ searchMaxCoin –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç
  const minC = Number(searchMinCoin.value || -Infinity); 
  const maxC = Number(searchMaxCoin.value || Infinity);
  const threshold = getThreshold();

  let arr = players.slice();

  // filters
  arr = arr.filter(p=>{
    if(q){
      if(!(p.nick && p.nick.toLowerCase().includes(q)) && !(p.id && p.id.includes(q))) return false;
    }
    if(filter==='online' && !isPlayerOnline(p, threshold)) return false;
    if(filter==='offline' && isPlayerOnline(p, threshold)) return false;
    if(filter==='banned' && !p.banned) return false;
    if(Number(p.coin) < minC) return false;
    if(Number(p.coin) > maxC) return false;
    return true;
  });

  // sort
  const sort = sortPlayers.value;
  if(sort==='recent') arr.sort((a,b)=> new Date(b.lastActive||0) - new Date(a.lastActive||0));
  if(sort==='coin_desc') arr.sort((a,b)=> (b.coin||0) - (a.coin||0));
  if(sort==='coin_asc') arr.sort((a,b)=> (a.coin||0) - (b.coin||0));

  arr.forEach(p=>{
    const tr = document.createElement('tr');
    const last = p.lastActive ? isoToLocal(p.lastActive) : '‚Äî';
    const online = isPlayerOnline(p, threshold);
    const bal = `${Math.round(p.coin)} / ${Number(p.ton).toFixed(4)} / ${Number(p.usdt).toFixed(4)} / ${Math.round(p.ticket)}`;
    tr.innerHTML = `
      <td><b>${escapeHtml(p.nick)}</b><div class="muted-2" style="font-size:12px">${p.id}</div></td>
      <td>${bal}</td>
      <td class="muted-2">${last}</td>
      <td>${online? '<span class="badge" style="background:linear-gradient(90deg,#28c76f,#16a34a);color:#07130f">–û–Ω–ª–∞–π–Ω</span>':'<span class="muted">–û—Ñ—Ñ–ª–∞–π–Ω</span>'}</td>
      <td>${p.banned? '<span class="badge" style="background:var(--danger);color:#111">–ó–∞–±–∞–Ω–µ–Ω</span>':'<span class="muted">OK</span>'}</td>
      <td>
        <div style="display:flex;gap:6px;flex-wrap:wrap" data-player-id="${p.id}">
          <button data-act="edit" class="small ghost">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button data-act="bonus" class="small">–ë–æ–Ω—É—Å</button>
          <button data-act="impersonate" class="small ghost">–ò–º–ø</button>
          <button data-act="ban" class="small danger">${p.banned? '–†–∞–∑–±–∞–Ω':'–ë–∞–Ω'}</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });

  playersCountEl.textContent = players.length;
  // stats (update only once)
  const t = totals(players);
  const onlineCount = players.filter(p=> isPlayerOnline(p, getThreshold())).length;
  statPlayers.textContent = players.length;
  statOnline.textContent = onlineCount;
  statCoin.textContent = Math.round(t.coin);
  statUSDT.textContent = Number(t.usdt).toFixed(4);
  statTON.textContent = Number(t.ton).toFixed(4);
  statTickets.textContent = Math.round(t.ticket);
}

function renderPromos(){
  const arr = load('promoCodes', []);
  promosList.innerHTML = '';
  if(arr.length===0){ promosList.innerHTML = '<div class="muted">–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ—Ç</div>'; return; }
  arr.forEach(p=>{
    const el = document.createElement('div');
    el.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
    el.style.padding = '10px';
    const activeStyle = p.active ? 'color: var(--success);' : 'color: var(--danger);';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center" data-promo-code="${p.code}">
        <div>
          <b>${p.code}</b> 
          <span style="${activeStyle}">${p.active ? ' (–ê–∫—Ç–∏–≤–µ–Ω)' : ' (–û—Ç–∫–ª—é—á–µ–Ω)'}</span>
          <div class="muted-2" style="font-size:12px">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π: ${p.uses}/${p.maxUses}</div>
        </div>
        <div style="display:flex;gap:8px">
          <button data-act="toggle" class="small">${p.active? '–û—Ç–∫–ª':'–í–∫–ª'}</button>
          <button data-act="simulate" class="small ghost">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button data-act="edit" class="small ghost">–†–µ–¥</button>
          <button data-act="del" class="small danger">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
      <div class="muted-2" style="margin-top:6px">–ù–∞–≥—Ä–∞–¥–∞: Coin:${p.reward.coin} Ticket:${p.reward.ticket} USDT:${p.reward.usdt} TON:${p.reward.ton}</div>`;
    promosList.appendChild(el);
  });
}

function renderRiddles(){
  const arr = load('riddles', []).sort((a,b)=> a.date.localeCompare(b.date));
  riddlesList.innerHTML = '';
  if(arr.length===0){ riddlesList.innerHTML = '<div class="muted">–ó–∞–≥–∞–¥–æ–∫ –Ω–µ—Ç</div>'; return; }
  const today = new Date().toISOString().slice(0,10);
  arr.forEach(r=>{
    const el = document.createElement('div');
    el.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
    el.style.padding = '10px';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center" data-riddle-id="${r.id}" data-riddle-q="${escapeHtml(r.q)}" data-riddle-date="${r.date}">
        <div><b>${r.date}</b> ‚Äî <span class="muted-2">${r.q}</span></div>
        <div style="display:flex;gap:8px">
          <button data-act="copy" class="small">Copy</button>
          <button data-act="edit" class="small ghost">–†–µ–¥</button>
          <button data-act="del" class="small danger">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
      <div class="muted-2" style="margin-top:6px">–û—Ç–≤–µ—Ç: ${r.answer||'‚Äî'}</div>`;
    if(r.date === today) el.style.background = 'linear-gradient(90deg, rgba(255,215,0,0.03), transparent)';
    riddlesList.appendChild(el);
  });
}

function renderTasks(){
  const arr = load('tasks', []);
  tasksList.innerHTML = '';
  if(arr.length===0){ tasksList.innerHTML = '<div class="muted">–ó–∞–¥–∞—á –Ω–µ—Ç</div>'; return; }
  arr.forEach(t=>{
    const el = document.createElement('div');
    el.style.borderBottom = '1px solid rgba(255,255,255,0.03)'; el.style.padding='10px';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center" data-task-id="${t.id}">
        <div><b>${t.title}</b><div class="muted-2" style="font-size:12px">${t.created.slice(0,10)}</div></div>
        <div style="display:flex;gap:8px">
          <button data-act="delete" class="small ghost">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
      <div class="muted-2" style="margin-top:6px">Reward: Coin:${t.reward.coin||0} Ticket:${t.reward.ticket||0} USDT:${t.reward.usdt||0} TON:${t.reward.ton||0}</div>`;
    tasksList.appendChild(el);
  });
}

function renderWithdraws(){
  const arr = load('withdrawRequests', []).sort((a,b)=> new Date(b.date || b.created) - new Date(a.date || a.created));
  withdrawsList.innerHTML = '';
  if(arr.length===0){ withdrawsList.innerHTML = '<div class="muted">–ù–µ—Ç –∑–∞—è–≤–æ–∫</div>'; } 
  arr.forEach(w=>{
    const player = (load('players',[]).find(p=>p.id===w.playerId) || {nick:'?', id:'?'});
    const el = document.createElement('div'); el.style.borderBottom='1px solid rgba(255,255,255,0.03)'; el.style.padding='10px';
    
    let statusClass, statusText;
    if (w.status === 'accepted') { statusClass = 'success'; statusText = '–ü—Ä–∏–Ω—è—Ç'; }
    else if (w.status === 'rejected') { statusClass = 'danger'; statusText = '–û—Ç–∫–ª–æ–Ω—ë–Ω'; }
    else { statusClass = 'accent'; statusText = '–ù–æ–≤—ã–π'; }

    const amountDisplay = Number(w.amount).toFixed(w.currency.toLowerCase()==='coin' ? 0 : 4);

    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <b>${player.nick}</b> ‚Äî ${amountDisplay} ${w.currency}
          <div class="muted-2" style="font-size:12px">${isoToLocal(w.date || w.created)}</div>
        </div>
        <div style="display:flex;gap:8px" data-withdraw-id="${w.id}">
          <span class="badge" style="background:var(--${statusClass});color:#111;margin-right:8px">${statusText}</span>
          ${w.status === 'new' ? `<button class="small" data-act="accept">–ü—Ä–∏–Ω—è—Ç—å</button>` : ''}
          ${w.status === 'new' ? `<button class="small danger" data-act="reject">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>` : ''}
        </div>
      </div>
      <div class="muted-2" style="margin-top:4px">–ö–æ—à–µ–ª–µ–∫: ${w.wallet}</div>
      <div class="muted-2" style="font-size:10px;margin-top:4px">ID: ${w.id}</div>
    `;
    withdrawsList.appendChild(el);
  });
  
  // Update stats
  statWD.textContent = load('withdrawRequests', []).filter(x=>!x.status || x.status==='new').length;
}

function renderSubmissions(){
    const arr = load('taskSubmissions', []).sort((a,b)=> new Date(b.date || b.created) - new Date(a.date || a.created));
    submissionsList.innerHTML = '';
    if(arr.length===0){ submissionsList.innerHTML = '<div class="muted">–ù–µ—Ç –∑–∞—è–≤–æ–∫</div>'; return; }
    
    arr.forEach(s=>{
        const player = (load('players',[]).find(p=>p.id===s.playerId) || {nick:'?', id:'?'});
        const el = document.createElement('div'); el.style.borderBottom='1px solid rgba(255,255,255,0.03)'; el.style.padding='10px';
        
        let statusClass, statusText;
        if (s.status === 'approved') { statusClass = 'success'; statusText = '–û–¥–æ–±—Ä–µ–Ω–∞'; }
        else if (s.status === 'rejected') { statusClass = 'danger'; statusText = '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞'; }
        else { statusClass = 'accent'; statusText = '–ù–æ–≤–∞—è'; }

        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <b>${player.nick}</b>: ${escapeHtml(s.text)}
              <div class="muted-2" style="font-size:12px">ID –∏–≥—Ä–æ–∫–∞: ${player.id}</div>
            </div>
            <div style="display:flex;gap:8px" data-submission-id="${s.id}">
              <span class="badge" style="background:var(--${statusClass});color:#111;margin-right:8px">${statusText}</span>
              ${s.status === 'new' ? `<button class="small" data-act="approve">–û–¥–æ–±—Ä–∏—Ç—å</button>` : ''}
              ${s.status === 'new' ? `<button class="small danger" data-act="reject">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>` : ''}
            </div>
          </div>
          <div class="muted-2" style="font-size:10px;margin-top:4px">ID: ${s.id}</div>
        `;
        submissionsList.appendChild(el);
    });
    // Update stats
    statSubs.textContent = load('taskSubmissions', []).filter(x=>!x.status || x.status==='new').length;
}

function renderAdminLog(){
  const arr = load('adminLog', []);
  adminLogDiv.innerHTML = arr.map(x=> `<div class="muted-2">${x.t} ‚Äî ${x.m}</div>`).join('');
}

function renderAll(){
  renderPlayers();
  renderPromos();
  renderRiddles();
  renderTasks();
  renderWithdraws();
  renderSubmissions(); // Added for completeness
  renderAdminLog();
  // set admin name field
  adminNameInput.value = localStorage.getItem('adminName') || '';
  // set threshold display
  const th = getThreshold();
  thShow.textContent = th;
  onlineThresholdInput.value = th;
}

/* ----------------- Event Listeners (Delegation and Init) ----------------- */

// --- GLOBAL HANDLERS ---
// Tab switching
tabs.forEach(el=>{
  el.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
    const tab = el.dataset.tab;
    contentTabs.forEach(ct=>{
      if(ct.id === 'tab-'+tab) ct.style.display = '';
      else ct.style.display = 'none';
    });
    renderAll(); // Rerender on tab switch is acceptable
  });
});

// Modal close on backdrop click
modalBack.addEventListener('click', (e)=>{ if(e.target === modalBack) closeModal(); });

// Admin Name save
adminNameInput.addEventListener('input', (e)=>{ localStorage.setItem('adminName', e.target.value); });

// --- PLAYERS TAB HANDLERS (Delegation for Table) ---
document.getElementById('playersTable').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const action = btn.dataset.act;
    const playerId = btn.closest('[data-player-id]').dataset.playerId;

    if (action === 'edit') openEditPlayerModal(playerId);
    else if (action === 'bonus') openBonusModal(playerId);
    else if (action === 'impersonate') { localStorage.setItem('impersonate', JSON.stringify({playerId:playerId})); toast('Impersonate set: '+playerId); logAdmin('Impersonate set '+playerId); }
    else if (action === 'ban') toggleBan(playerId);
});

// Search, Filter, Sort triggers
searchPlayer.addEventListener('input', renderPlayers);
filterOnline.addEventListener('change', renderPlayers);
sortPlayers.addEventListener('change', renderPlayers);
document.getElementById('applyBalanceFilter').addEventListener('click', renderPlayers);
document.getElementById('clearFilters').addEventListener('click', ()=>{ 
    document.getElementById('minCoin').value=''; 
    document.getElementById('maxCoin').value=''; 
    searchPlayer.value=''; 
    filterOnline.value='all'; 
    sortPlayers.value='recent'; 
    renderAll(); 
});

// Bulk actions
document.getElementById('applyBulk').addEventListener('click', ()=>{ 
    const action = document.getElementById('bulkAction').value; 
    const value = document.getElementById('bulkValue').value;
    if(!action) return toast('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ'); 
    bulkActionApply(action, value); 
});

// --- PROMOS TAB HANDLERS (Delegation) ---
document.getElementById('promosList').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const action = btn.dataset.act;
    const code = btn.closest('[data-promo-code]').dataset.promoCode;

    if (action === 'toggle') togglePromo(code);
    else if (action === 'simulate') openSimulatePromoModal(code);
    else if (action === 'del') { if(confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ '+code+'?')) deletePromo(code); }
    // Note: Edit functionality for promo is missing from the original, skipping for now
});

document.getElementById('clearPromos').addEventListener('click', ()=>{
    if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã?')){ save('promoCodes', []); logAdmin('–í—Å–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã –æ—á–∏—â–µ–Ω—ã'); renderPromos(); }
});

// --- RIDDLES TAB HANDLERS (Delegation) ---
document.getElementById('riddlesList').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const action = btn.dataset.act;
    const item = btn.closest('[data-riddle-id]');
    const id = item.dataset.riddleId;
    
    if (action === 'copy'){ 
        navigator.clipboard?.writeText(item.dataset.riddleQ || item.dataset.riddleDate); 
        toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); 
    }
    else if (action === 'edit') openEditRiddleModal(id);
    else if (action === 'del') { if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–≥–∞–¥–∫—É?')) deleteRiddle(id); }
});

document.getElementById('clearRiddles').addEventListener('click', ()=>{
    if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–≥–∞–¥–∫–∏?')){ save('riddles', []); logAdmin('–í—Å–µ –∑–∞–≥–∞–¥–∫–∏ –æ—á–∏—â–µ–Ω—ã'); renderRiddles(); }
});

// --- TASKS TAB HANDLERS (Delegation) ---
document.getElementById('tasksList').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const action = btn.dataset.act;
    const id = btn.closest('[data-task-id]').dataset.taskId;

    if (action === 'delete') { if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) deleteTask(id); }
});

// --- WITHDRAWS/SUBMISSIONS TAB HANDLERS (Delegation) ---
document.getElementById('withdrawsList').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const action = btn.dataset.act;
    const id = btn.closest('[data-withdraw-id]').dataset.withdrawId;
    
    if (action === 'accept') acceptWithdraw(id);
    else if (action === 'reject') rejectWithdraw(id);
});

document.getElementById('submissionsList').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const action = btn.dataset.act;
    const id = btn.closest('[data-submission-id]').dataset.submissionId;
    
    if (action === 'approve') approveSubmission(id);
    else if (action === 'reject') rejectSubmission(id);
});

// --- MODAL OPENERS ---
document.getElementById('openAddPlayer').addEventListener('click', openAddPlayerModal);
document.getElementById('openAddPromo').addEventListener('click', openAddPromoModal);
document.getElementById('openAddRiddle').addEventListener('click', openAddRiddleModal);
document.getElementById('openAddTask').addEventListener('click', openAddTaskModal);

// --- SETTINGS/MISC ACTIONS ---
document.getElementById('saveThreshold').addEventListener('click', ()=>{ 
    const v = Number(onlineThresholdInput.value) || 5; 
    localStorage.setItem('admin_online_threshold', String(v)); 
    thShow.textContent = v; 
    logAdmin('–ü–æ—Ä–æ–≥ –æ–Ω–ª–∞–π–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: '+v+' –º–∏–Ω'); 
    renderAll(); 
});

document.getElementById('notifySync').addEventListener('click', ()=>{ 
    localStorage.setItem('lastAdminAction', JSON.stringify({t:'sync',ts:Date.now()})); 
    toast('–°–∏–≥–Ω–∞–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω'); 
});

document.getElementById('clearLocalStorage').addEventListener('click', ()=>{ 
    if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å localStorage? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–∞–Ω–µ–ª–∏!')) return; 
    localStorage.clear(); 
    location.reload(); 
});

document.getElementById('addDemo').addEventListener('click', ()=>{ 
    addPlayer('Demo_'+Math.random().toString(36).slice(2,6)); 
    renderAll();
});

document.getElementById('pingAll').addEventListener('click', ()=>{ 
    const players = load('players',[]); 
    players.forEach(p=>p.lastActive = new Date().toISOString()); 
    save('players', players); 
    logAdmin('–û—Ç–º–µ—Ç–∏–ª –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã–º–∏'); 
    renderAll(); 
});

document.getElementById('wipeAll').addEventListener('click', ()=>{ 
    if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ (players,promoCodes,tasks,riddles,withdraws,submissions)?')){ 
        save('players',[]); 
        save('promoCodes',[]); 
        save('tasks',[]); 
        save('riddles',[]); 
        save('withdrawRequests',[]); 
        save('taskSubmissions',[]); 
        save('transactionHistory',[]); 
        save('adminLog',[]); 
        localStorage.setItem('admin_online_threshold', '5'); 
        logAdmin('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã'); 
        renderAll(); 
    } 
});

// --- EXPORT/IMPORT ACTIONS ---
document.getElementById('exportAll').addEventListener('click', ()=>{ 
    const data = {
        players: load('players',[]), 
        promoCodes: load('promoCodes',[]), 
        riddles: load('riddles',[]), 
        tasks: load('tasks',[]), 
        withdrawRequests: load('withdrawRequests',[]), 
        taskSubmissions: load('taskSubmissions',[]), 
        transactionHistory: load('transactionHistory',[]), 
        adminLog: load('adminLog',[])
    };
    downloadJSON(data, 'admin_panel_backup_'+new Date().toISOString().slice(0,10)+'.json');
    logAdmin('–ü–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö');
});

document.getElementById('importAll').addEventListener('click', ()=>{
    const raw = prompt('–í—Å—Ç–∞–≤—å—Ç–µ JSON –±—ç–∫–∞–ø–∞');
    if(!raw) return;
    try{
        const obj = JSON.parse(raw);
        if(obj.players) save('players', obj.players);
        if(obj.promoCodes) save('promoCodes', obj.promoCodes);
        if(obj.riddles) save('riddles', obj.riddles);
        if(obj.tasks) save('tasks', obj.tasks);
        if(obj.withdrawRequests) save('withdrawRequests', obj.withdrawRequests);
        if(obj.taskSubmissions) save('taskSubmissions', obj.taskSubmissions);
        if(obj.transactionHistory) save('transactionHistory', obj.transactionHistory);
        if(obj.adminLog) save('adminLog', obj.adminLog);
        logAdmin('–ò–º–ø–æ—Ä—Ç –±—ç–∫–∞–ø–∞');
        renderAll();
    }catch(e){ toast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON'); }
});

// Player-specific Export/Import
document.getElementById('exportPlayers').addEventListener('click', ()=>{ 
    downloadJSON(load('players',[]), 'players_export.json');
    logAdmin('–≠–∫—Å–ø–æ—Ä—Ç —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤');
});
document.getElementById('importPlayers').addEventListener('click', ()=>{
    const raw = prompt('–í—Å—Ç–∞–≤—å—Ç–µ JSON —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤');
    if(!raw) return;
    try{
        const arr = JSON.parse(raw);
        if(Array.isArray(arr)) { save('players', arr); logAdmin('–ò–º–ø–æ—Ä—Ç —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤'); renderAll(); }
        else toast('–û—à–∏–±–∫–∞: –æ–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤ –∏–≥—Ä–æ–∫–æ–≤');
    }catch(e){ toast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON'); }
});

// Export Promos/Riddles/Withdraws/Tasks (similarly implemented but for brevity kept as-is)
document.getElementById('exportPromos').addEventListener('click', ()=>{ downloadJSON(load('promoCodes',[]), 'promos_export.json'); logAdmin('–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤'); });
document.getElementById('exportRiddles').addEventListener('click', ()=>{ downloadJSON(load('riddles',[]), 'riddles_export.json'); logAdmin('–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≥–∞–¥–æ–∫'); });
document.getElementById('exportTasks').addEventListener('click', ()=>{ downloadJSON(load('tasks',[]), 'tasks_export.json'); logAdmin('–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–¥–∞—á'); });
document.getElementById('exportWithdraws').addEventListener('click', ()=>{ downloadJSON(load('withdrawRequests',[]), 'withdraws_export.json'); logAdmin('–≠–∫—Å–ø–æ—Ä—Ç –≤—ã–≤–æ–¥–æ–≤'); });


/* ----------------- listeners for storage events (sync with main app) ----------------- */
window.addEventListener('storage', (e)=>{
  if(['players','promoCodes','tasks','riddles','withdrawRequests','taskSubmissions','adminLog','transactionHistory','admin_online_threshold'].includes(e.key) || e.key===null){
    setTimeout(()=> renderAll(), 120);
  }
});

/* ----------------- initialization & render all ----------------- */
renderAll();
</script>
</body>
</html>
